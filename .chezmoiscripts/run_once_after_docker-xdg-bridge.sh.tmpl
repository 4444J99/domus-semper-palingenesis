#!/usr/bin/env bash
# Bridge Docker Desktop's ~/.docker into XDG-compliant $DOCKER_CONFIG
# Docker Desktop manages cli-plugins and config.json at ~/.docker/,
# but DOCKER_CONFIG is set to ~/.config/docker (15-env.zsh).
# Symlink the Desktop-managed files so the CLI finds them at $DOCKER_CONFIG.

set -euo pipefail

{{- if ne .chezmoi.os "darwin" }}
exit 0
{{- end }}

src="$HOME/.docker"
dest="${XDG_CONFIG_HOME:-$HOME/.config}/docker"

if [ ! -d "$src" ]; then
  echo "‚ö†Ô∏è  ~/.docker does not exist (Docker Desktop not installed?) ‚Äî skipping"
  exit 0
fi

mkdir -p "$dest"

# Symlink cli-plugins (Docker Desktop manages this directory)
if [ ! -e "$dest/cli-plugins" ]; then
  ln -s "$src/cli-plugins" "$dest/cli-plugins"
  echo "‚úÖ Symlinked $dest/cli-plugins ‚Üí $src/cli-plugins"
fi

# Symlink config.json (Docker Desktop manages this file)
if [ ! -e "$dest/config.json" ]; then
  ln -s "$src/config.json" "$dest/config.json"
  echo "‚úÖ Symlinked $dest/config.json ‚Üí $src/config.json"
fi

# Symlink contexts (Docker Desktop manages this directory)
if [ -d "$src/contexts" ] && [ ! -e "$dest/contexts" ]; then
  ln -s "$src/contexts" "$dest/contexts"
  echo "‚úÖ Symlinked $dest/contexts ‚Üí $src/contexts"
fi

echo "üê≥ Docker XDG bridge complete"
