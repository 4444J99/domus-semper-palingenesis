#!/usr/bin/env bash
# Load/reload launchd agents (chezmoi + domus)
# Runs when plist files change

{{- if eq .chezmoi.os "darwin" }}

set -euo pipefail

echo "Managing launchd agents..."

# Ensure state directories exist
mkdir -p "${HOME}/.local/share/chezmoi-health"
mkdir -p "${HOME}/.local/state/domus/telemetry"
mkdir -p "${HOME}/.local/state/domus/normalize"
mkdir -p "${HOME}/.local/state/domus/photo_sort"

# Function to load/reload an agent
load_agent() {
  local plist_path="$1"
  local label="$2"
  local name="$3"

  echo ""
  echo ":: $name"

  if [[ ! -f "${plist_path}" ]]; then
    echo "   Plist not found, skipping"
    return 0
  fi

  # Unload if already loaded
  if launchctl list "${label}" &>/dev/null; then
    echo "   Unloading existing agent..."
    launchctl unload "${plist_path}" 2>/dev/null || true
  fi

  # Load the agent
  echo "   Loading agent..."
  if launchctl load "${plist_path}"; then
    if launchctl list "${label}" &>/dev/null; then
      echo "   Loaded successfully"
    else
      echo "   WARNING: Agent may not have started"
    fi
  else
    echo "   ERROR: Failed to load agent"
  fi
}

# Load chezmoi self-heal agent
load_agent \
  "${HOME}/Library/LaunchAgents/com.chezmoi.self-heal.plist" \
  "com.chezmoi.self-heal" \
  "chezmoi-daemon (4hr drift check)"

# Load domus daemon agent
load_agent \
  "${HOME}/Library/LaunchAgents/com.domus.daemon.plist" \
  "com.domus.daemon" \
  "domus-daemon (hourly orchestrator)"

# Load domus file sorter agent
load_agent \
  "${HOME}/Library/LaunchAgents/com.domus.sort.plist" \
  "com.domus.sort" \
  "domus-sort (file watcher)"

# Load desktop router agent
load_agent \
  "${HOME}/Library/LaunchAgents/com.4jp.desktop-router.plist" \
  "com.4jp.desktop-router" \
  "desktop-router (Desktop file watcher)"

# Load home root guard agent
load_agent \
  "${HOME}/Library/LaunchAgents/com.4jp.home-root-guard.plist" \
  "com.4jp.home-root-guard" \
  "home-root-guard (15min home cleanup)"

# Load downloads tidy agent
load_agent \
  "${HOME}/Library/LaunchAgents/com.4jp.downloads-tidy.plist" \
  "com.4jp.downloads-tidy" \
  "downloads-tidy (nightly 3:15am)"

# Load naming maintenance agent
load_agent \
  "${HOME}/Library/LaunchAgents/com.4jp.naming-maintenance.plist" \
  "com.4jp.naming-maintenance" \
  "naming-maintenance (4hr cloud hygiene)"

echo ""
echo "Management commands:"
echo "  Status:  launchctl list | grep -E 'chezmoi|domus|4jp'"
echo "  Logs:    tail -f ~/.local/state/domus/*.log"
echo ""

{{- else }}
echo "Skipping launchd setup (not macOS)"
{{- end }}
