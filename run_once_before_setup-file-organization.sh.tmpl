#!/bin/bash
# Setup universal file organization structure
# This runs once on new machines to create the organized structure

set -e

echo "üóÇÔ∏è  Setting up universal file organization..."

# Create XDG Base Directories
echo "Creating XDG directories..."
mkdir -p ~/.config
mkdir -p ~/.local/{bin,share,state}
mkdir -p ~/.cache

# Create organized user directories
echo "Creating organized project structure..."
mkdir -p ~/Projects/{Active,Archive}
mkdir -p ~/Documents/{Work,Personal,Archive,Notes}

# Create context/metadata system
echo "Creating file context system..."
mkdir -p ~/.local/share/file-context/{manifests,links}
mkdir -p ~/.local/share/file-context/links/{by-type,by-project,by-year,by-status}

# Create symlink categories
mkdir -p ~/.local/share/file-context/links/by-type/{code,docs,media,data}
mkdir -p ~/.local/share/file-context/links/by-status/{active,archived,reference}

{{- if eq .chezmoi.os "darwin" }}
# macOS: Check for external drive and create stable symlinks
EXTERNAL_DRIVE="/Volumes/4444-iivii"

if [ -d "$EXTERNAL_DRIVE" ]; then
  echo "External drive found! Creating stable symlinks..."

  # Main external drive symlink
  if [ ! -e ~/External ]; then
    ln -sf "$EXTERNAL_DRIVE" ~/External
    echo "  ‚úÖ Created ~/External ‚Üí $EXTERNAL_DRIVE"
  fi

  # Workspace symlink
  if [ -d "$EXTERNAL_DRIVE/ivi374forivi3ivi3/workspace" ] && [ ! -e ~/Projects/ivi374 ]; then
    ln -sf "$EXTERNAL_DRIVE/ivi374forivi3ivi3/workspace" ~/Projects/ivi374
    echo "  ‚úÖ Created ~/Projects/ivi374 ‚Üí workspace"
  fi

  # Toolchains symlink
  if [ -d "$EXTERNAL_DRIVE/ivi374forivi3ivi3/toolchains" ] && [ ! -e ~/.local/share/toolchains ]; then
    ln -sf "$EXTERNAL_DRIVE/ivi374forivi3ivi3/toolchains" ~/.local/share/toolchains
    echo "  ‚úÖ Created ~/.local/share/toolchains"
  fi
else
  echo "  ‚ö†Ô∏è  External drive not mounted at $EXTERNAL_DRIVE"
  echo "     Symlinks will be created when you connect the drive"
fi
{{- end }}

# Create file context manifest template
cat > ~/.local/share/file-context/manifests/README.md <<'MANIFEST_EOF'
# File Context Manifests

This directory contains YAML manifests that describe your file organization.

## Example: projects.yaml

```yaml
projects:
  active:
    - name: "my-app"
      path: "~/Projects/Active/my-app"
      type: "development"
      tags: ["nodejs", "web", "active"]
      external_backup: "~/External/Archive/my-app"

  archived:
    - name: "old-project"
      path: "~/External/Archive/Projects/2023/old-project"
      archived_date: "2023-12-01"
      tags: ["archived", "reference", "python"]
```

## Usage

1. Create manifests for different categories (projects, documents, media)
2. Use tags to organize and find files
3. Track where files are (local vs external)
4. Document why files exist and their purpose
MANIFEST_EOF

# Create a helper script for file organization
cat > ~/.local/bin/file-org <<'FILEORG_EOF'
#!/bin/bash
# Universal file organization helper

case "$1" in
  inventory)
    echo "üìã Creating file inventory..."
    du -sh ~/* 2>/dev/null | sort -hr > ~/file-inventory-$(date +%Y%m%d).txt
    echo "Saved to ~/file-inventory-$(date +%Y%m%d).txt"
    ;;

  clean-root)
    echo "üßπ Files in home root (should be moved):"
    ls -la ~/ | grep -v "^d" | grep -v "^l" | awk '{print $9}' | grep -v "^\." | grep -v "^$"
    ;;

  check-external)
    if [ -d ~/External ]; then
      echo "‚úÖ External drive connected at ~/External"
      du -sh ~/External/* 2>/dev/null | sort -hr | head -10
    else
      echo "‚ùå External drive not connected"
    fi
    ;;

  link-project)
    if [ -z "$2" ]; then
      echo "Usage: file-org link-project <project-name>"
      exit 1
    fi
    PROJECT="$2"
    mkdir -p ~/.local/share/file-context/links/by-project/$PROJECT
    echo "Created link directory for project: $PROJECT"
    echo "Add symlinks: ln -s /path/to/files ~/.local/share/file-context/links/by-project/$PROJECT/..."
    ;;

  *)
    echo "Universal File Organization Helper"
    echo ""
    echo "Usage: file-org <command>"
    echo ""
    echo "Commands:"
    echo "  inventory      - Create size inventory of home directory"
    echo "  clean-root     - List files in home root that should be moved"
    echo "  check-external - Check external drive status"
    echo "  link-project   - Create project link structure"
    ;;
esac
FILEORG_EOF

chmod +x ~/.local/bin/file-org

echo ""
echo "‚úÖ File organization structure created!"
echo ""
echo "Next steps:"
echo "  1. Run: file-org inventory      # See what you have"
echo "  2. Run: file-org clean-root     # Find files to organize"
echo "  3. Run: file-org check-external # Check external drive"
echo ""
echo "üìö Read ORGANIZATION_STRATEGY.md for detailed guide"
