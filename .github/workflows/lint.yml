name: Lint & Validate

on:
  push:
    branches: [master]
  pull_request:
    branches: [master]

jobs:
  shellcheck:
    name: ShellCheck
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Install ShellCheck
        run: sudo apt-get install -y shellcheck
      - name: Run ShellCheck on non-template scripts
        run: |
          find dot_local/bin -name 'executable_*' ! -name '*.tmpl' -exec shellcheck -x {} +
      - name: Run ShellCheck on template scripts
        run: |
          for file in $(find . -name '*.sh.tmpl' ! -path './.git/*'); do
            echo "Checking: $file"
            tmp=$(mktemp)
            sed 's/{{[^}]*}}//g' "$file" > "$tmp"
            shellcheck -x -s bash "$tmp" || exit 1
            rm "$tmp"
          done

  yamllint:
    name: YAML Lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Install yamllint
        run: pip install yamllint
      - name: Run yamllint
        run: |
          find . -name '*.yml' -o -name '*.yaml' | \
            grep -v '.git/' | grep -v 'node_modules/' | \
            xargs yamllint -c .yamllint.yml

  validate-json:
    name: JSON Validation
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Validate JSON files
        run: |
          find . -name '*.json' ! -path './.git/*' ! -name '*.tmpl' | while read -r file; do
            echo "Validating: $file"
            python3 -m json.tool "$file" > /dev/null
          done

  shfmt:
    name: Shell Formatting
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Install shfmt
        run: |
          curl -sS https://webinstall.dev/shfmt | bash
          export PATH="$HOME/.local/bin:$PATH"
      - name: Check shell formatting
        run: |
          export PATH="$HOME/.local/bin:$PATH"
          find dot_local/bin -name 'executable_*' ! -name '*.tmpl' -exec shfmt -d -i 2 -ci {} +

  template-check:
    name: Template Validation
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Install chezmoi
        run: sh -c "$(curl -fsLS get.chezmoi.io)"
      - name: Validate templates parse
        run: |
          # Check that templates have valid Go template syntax
          find . -name '*.tmpl' ! -path './.git/*' | while read -r file; do
            echo "Checking template syntax: $file"
            # Basic syntax check: ensure {{ }} pairs are balanced
            opens=$(grep -o '{{' "$file" | wc -l)
            closes=$(grep -o '}}' "$file" | wc -l)
            if [ "$opens" -ne "$closes" ]; then
              echo "ERROR: Unbalanced template delimiters in $file ({{ = $opens, }} = $closes)"
              exit 1
            fi
          done
          echo "All templates have balanced delimiters"

  bats:
    name: BATS Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Install BATS
        run: sudo apt-get install -y bats
      - name: Run BATS tests
        run: bats tests/*.bats

  python-lint:
    name: Python Lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Install ruff
        run: pip install ruff
      - name: Run ruff on Python scripts
        run: |
          find dot_local/bin -name 'executable_*' -exec file {} + | \
            grep -i python | cut -d: -f1 | \
            xargs -r ruff check --select E,F,W

  pytest:
    name: Python Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.13"
      - run: pip install pytest
      - run: python -m pytest tests/ -q

  doc-lint:
    name: Doc References
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Check for stale function references
        run: |
          if grep -rn 'maintain()\|maintain-quick\|cache-sizes()' docs/ README.md 2>/dev/null; then
            echo "Found stale function references in docs"
            exit 1
          fi
          echo "No stale references found"

  gitleaks:
    name: Secret Scanning
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - uses: gitleaks/gitleaks-action@v2
        env:
          GITLEAKS_CONFIG: .gitleaks.toml
