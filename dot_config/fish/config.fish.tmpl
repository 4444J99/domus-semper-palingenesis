# ─────────────────────────────────────────────────────────────────────────────
# Fish Shell Configuration - Managed by Chezmoi
# ─────────────────────────────────────────────────────────────────────────────
#
# Setup is split into conf.d/ fragments (sourced before this file):
#   00-path.fish.tmpl  - PATH setup with OS/arch conditionals + timing start
#   10-env.fish        - XDG, EDITOR, environment variables
#   20-tools.fish      - starship, zoxide, fzf, atuin, direnv, mise, navi
#   30-aliases.fish    - abbreviations and aliases
#   40-functions.fish  - ktheme, cht, myip, localip
#   50-theme.fish      - pywal, lolcat
#
# This file handles: startup timing end + conda init.

if status is-interactive
    # ─────────────────────────────────────────────────────────────────────────
    # Startup Timing - Record (Domus Telemetry)
    # ─────────────────────────────────────────────────────────────────────────

    # Record shell startup time asynchronously
    # _domus_shell_start_ms is set in conf.d/00-path.fish.tmpl
    if test -n "$_domus_shell_start_ms" -a "$_domus_shell_start_ms" != "0"
        fish -c '
            set -l end_ms (perl -MTime::HiRes=time -e "printf \"%d\", time * 1000" 2>/dev/null; or echo 0)
            if test "$end_ms" != "0"
                set -l duration (math "$end_ms - '$_domus_shell_start_ms'")
                set -l telemetry_dir "$HOME/.local/state/domus/telemetry"
                set -l telemetry_file "$telemetry_dir/shell-startup.jsonl"

                # Only record if reasonable (< 30 seconds)
                if test $duration -gt 0 -a $duration -lt 30000
                    mkdir -p "$telemetry_dir"
                    set -l ts (date -u +"%Y-%m-%dT%H:%M:%SZ")
                    echo "{\"timestamp\":\"$ts\",\"ms\":$duration}" >> "$telemetry_file"

                    # Keep file under 100 entries
                    if test -f "$telemetry_file"
                        set -l lines (wc -l < "$telemetry_file" | string trim)
                        if test $lines -gt 100
                            tail -50 "$telemetry_file" > "$telemetry_file.tmp"
                            mv "$telemetry_file.tmp" "$telemetry_file"
                        end
                    end
                end
            end
        ' &
        disown
    end
    set -e _domus_shell_start_ms

end

# >>> conda initialize >>>
# !! Contents within this block are managed by 'conda init' !!
if test -f /opt/anaconda3/bin/conda
    eval /opt/anaconda3/bin/conda "shell.fish" "hook" $argv | source
else
    if test -f "/opt/anaconda3/etc/fish/conf.d/conda.fish"
        . "/opt/anaconda3/etc/fish/conf.d/conda.fish"
    else
        set -x PATH "/opt/anaconda3/bin" $PATH
    end
end
# <<< conda initialize <<<
