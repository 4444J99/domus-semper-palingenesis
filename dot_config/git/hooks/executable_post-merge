#!/bin/bash
# ─────────────────────────────────────────────────────────────────────────────
# Git post-merge hook - Chezmoi integration
# Managed by Chezmoi
# ─────────────────────────────────────────────────────────────────────────────
# Checks for drift after merging in the chezmoi source dir
# Optionally auto-applies via CHEZMOI_AUTO_APPLY_ON_MERGE=true

# Get the root of the current git repo
REPO_ROOT=$(git rev-parse --show-toplevel 2>/dev/null) || exit 0

# Chezmoi source directory
CHEZMOI_SOURCE="${HOME}/.local/share/chezmoi"

# Check if we're in the chezmoi source directory
if [[ "${REPO_ROOT}" == "${CHEZMOI_SOURCE}" ]]; then
  echo ""
  echo "━━━ Chezmoi Self-Heal ━━━"
  echo "Merged changes into dotfiles source."
  echo ""

  # Check if there's drift
  if chezmoi diff --quiet 2>/dev/null; then
    echo "✓ No drift - target files already match source"
  else
    DRIFT_COUNT=$(chezmoi diff 2>/dev/null | grep -E '^\+\+\+ b/' | wc -l | tr -d ' ')
    echo "! ${DRIFT_COUNT} file(s) have drifted from source"
    echo ""

    # If CHEZMOI_AUTO_APPLY_ON_MERGE is set, auto-apply
    if [[ "${CHEZMOI_AUTO_APPLY_ON_MERGE:-}" == "true" ]]; then
      echo "Auto-applying (CHEZMOI_AUTO_APPLY_ON_MERGE=true)..."

      # Create a quick backup first
      BACKUP_DIR="${HOME}/.local/share/chezmoi-health/backups/merge-$(date +%Y%m%d-%H%M%S)"
      mkdir -p "${BACKUP_DIR}"

      # Backup drifted files
      chezmoi diff 2>/dev/null | grep -E '^\+\+\+ b/' | sed 's/^+++ b\///' | while read -r file; do
        if [[ -f "${HOME}/${file}" ]]; then
          mkdir -p "${BACKUP_DIR}/$(dirname "${file}")"
          cp "${HOME}/${file}" "${BACKUP_DIR}/${file}"
        fi
      done

      # Apply changes
      if chezmoi apply --force; then
        echo "✓ Changes applied (backup at: ${BACKUP_DIR})"
      else
        echo "✗ Apply failed - check chezmoi status"
      fi
    else
      echo "  Run: chezmoi apply"
      echo "  Or:  chezmoi diff   (to preview changes)"
      echo ""
      echo "  Tip: Set CHEZMOI_AUTO_APPLY_ON_MERGE=true to auto-apply"
    fi
  fi
  echo "━━━━━━━━━━━━━━━━━━━━━━━━"
  echo ""
fi

exit 0
